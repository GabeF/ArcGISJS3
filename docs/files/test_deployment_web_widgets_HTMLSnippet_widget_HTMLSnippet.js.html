<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test\deployment\web\widgets\HTMLSnippet\widget\HTMLSnippet.js - YUI ArcGIS</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="YUI ArcGIS" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Main.html">Main</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: test\deployment\web\widgets\HTMLSnippet\widget\HTMLSnippet.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*jslint -W061:false*/
define([
    &quot;dojo/_base/declare&quot;,
    &quot;mxui/widget/_WidgetBase&quot;,
    &quot;dojo/dom-style&quot;,
    &quot;dojo/dom-attr&quot;,
    &quot;dojo/dom-construct&quot;,
    &quot;dojo/_base/lang&quot;,
    &quot;dojo/html&quot;,
    &quot;dijit/layout/LinkPane&quot;
], function (
    declare,
    _WidgetBase,
    domStyle,
    domAttr,
    domConstruct,
    lang,
    html,
    LinkPane
) {
    &quot;use strict&quot;;

    return declare(&quot;HTMLSnippet.widget.HTMLSnippet&quot;, [_WidgetBase], {
        // Set in Modeler
        contenttype: &quot;html&quot;,
        contents: &quot;&quot;,
        contentsPath: &quot;&quot;,
        onclickmf: &quot;&quot;,
        documentation: &quot;&quot;,
        refreshOnContextChange: false,
        refreshOnContextUpdate: false,
        encloseHTMLWithDiv: true,

        // Internal
        _objectChangeHandler: null,
        contextObj: null,

        postCreate: function () {
            logger.debug(this.id + &quot;.postCreate&quot;);
            this._setupEvents();

            if (!this.refreshOnContextChange) {
                this.executeCode();
            }
        },

        executeCode: function () {
            logger.debug(this.id + &quot;.executeCode&quot;);
            var external = this.contentsPath !== &quot;&quot; ? true : false;
            switch (this.contenttype) {
                case &quot;html&quot;:
                    if (external) {
                        new LinkPane({
                                preload: true,
                                loadingMessage: &quot;&quot;,
                                href: this.contentsPath,
                                onDownloadError: function () {
                                    console.log(&quot;Error loading html path&quot;);
                                }
                            })
                            .placeAt(this.domNode.id)
                            .startup();
                    } else if (!this.encloseHTMLWithDiv) {
                        html.set(this.domNode, this.contents);
                    } else {
                        domStyle.set(this.domNode, {
                            height: &quot;auto&quot;,
                            width: &quot;100%&quot;,
                            outline: 0
                        });

                        domAttr.set(this.domNode, &quot;style&quot;, this.style); // might override height and width
                        var domNode = domConstruct.create(&quot;div&quot;, {
                            innerHTML: this.contents
                        });
                        domConstruct.place(domNode, this.domNode, &quot;only&quot;);
                    }
                    break;

                case &quot;js&quot;:
                case &quot;jsjQuery&quot;:
                    if (external) {
                        var scriptNode = document.createElement(&quot;script&quot;),
                            intDate = +new Date();

                        scriptNode.type = &quot;text/javascript&quot;;
                        scriptNode.src =
                            this.contentsPath + &quot;?v=&quot; + intDate.toString();

                        domConstruct.place(scriptNode, this.domNode, &quot;only&quot;);
                    } else {
                        if (this.contenttype === &quot;jsjQuery&quot;) {
                            this._evalJQueryCode();
                        } else {
                            this.evalJs();
                        }
                    }
                    break;
            }
        },

        update: function (obj, callback) {
            logger.debug(this.id + &quot;.update&quot;);
            this.contextObj = obj;
            if (this.refreshOnContextChange) {
                this.executeCode();

                if (this.refreshOnContextUpdate) {
                    if (this._objectChangeHandler !== null) {
                        this.unsubscribe(this._objectChangeHandler);
                    }
                    if (obj) {
                        this._objectChangeHandler = this.subscribe({
                            guid: obj.getGuid(),
                            callback: lang.hitch(this, function () {
                                this.executeCode();
                            })
                        });
                    }
                }
            }

            this._executeCallback(callback, &quot;update&quot;);
        },

        _setupEvents: function () {
            logger.debug(this.id + &quot;._setupEvents&quot;);
            if (this.onclickmf) {
                this.connect(
                    this.domNode,
                    &quot;click&quot;,
                    this._executeMicroflow
                );
            }
        },

        _executeMicroflow: function () {
            logger.debug(this.id + &quot;._executeMicroflow&quot;);
            if (this.onclickmf) {
                var params = {};
                if (this.contextObj !== null) {
                    params.applyto = &quot;selection&quot;;
                    params.guids = [this.contextObj.getGuid()];
                }
                mx.ui.action(
                    this.onclickmf, {
                        params: params,
                        callback: function (obj) {
                            logger.debug(
                                this.id + &quot; (executed microflow successfully).&quot;
                            );
                        },
                        error: function (error) {
                            logger.error(this.id + error);
                        }
                    },
                    this
                );
            }
        },

        evalJs: function () {
            logger.debug(this.id + &quot;.evalJS&quot;);
            try {
                eval(this.contents + &quot;\r\n//# sourceURL=&quot; + this.id + &quot;.js&quot;);
            } catch (error) {
                this._handleError(error);
            }
        },

        _evalJQueryCode: function () {
            logger.debug(this.id + &quot;._evalJQueryCode&quot;);
            /*** load jQuery ***/
            require([&quot;HTMLSnippet/lib/jquery-3.3.1&quot;], lang.hitch(this, function (jquery_3_3_1) {
                try {

                    (function (snippetCode) {

                        /**
                         *  user&#x27;s are get used to or might expect to have jQuery available globaly
                         *  and they will write their code according to that, and since we, in this widget, don&#x27;t expose 
                         *  jQuery globaly, we&#x27;ll check user&#x27;s code snippet if there is any attemption to access jQuery 
                         *  from the global scope ( window ). 
                         */
                        var jqueryIdRegex1 = /window.\jQuery/g;
                        var jqueryIdRegex2 = /window.\$/g;
                        snippetCode = snippetCode.replace(jqueryIdRegex1, &#x27;jQuery&#x27;);
                        snippetCode = snippetCode.replace(jqueryIdRegex2, &#x27;$&#x27;);

                        snippetCode = &quot;var jQuery, $; jQuery = $ = this.jquery;&quot; + // make this jQuery version only accessible and availabe in the scope of this anonymous function
                            snippetCode +
                            &quot;console.debug(&#x27;your code snippet is evaluated and executed against JQuery version:&#x27;+ this.jquery.fn.jquery);&quot;;
                        eval(snippetCode);
                    }).call({
                        jquery: jquery_3_3_1 // pass JQuery as the context of the immediate function which will wrap the code snippet
                    }, this.contents); // pass the code snippet as an arg
                } catch (error) {
                    this._handleError(error);
                }
            }));
        },


        _handleError: function (error) {
            logger.debug(this.id + &quot;._handleError&quot;);
            domConstruct.place(
                &#x27;&lt;div class=&quot;alert alert-danger&quot;&gt;Error while evaluating javascript input: &#x27; +
                error +
                &quot;&lt;/div&gt;&quot;,
                this.domNode,
                &quot;only&quot;
            );
        },

        _executeCallback: function (cb, from) {
            logger.debug(this.id + &quot;._executeCallback&quot; + (from ? &quot; from &quot; + from : &quot;&quot;));
            if (cb &amp;&amp; typeof cb === &quot;function&quot;) {
                cb();
            }
        }
    });
});

require([&quot;HTMLSnippet/widget/HTMLSnippet&quot;]);

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
